.container.mt-4
  .card.shadow
    .card-header
      %h2.mb-0= "#{@division.event.name} #{@division.name}"

    .card-body
      %p
        %strong Event:
        = link_to @division.event.name, @division.event

      %p
        %strong Age Range:
        = "#{@division.min_age} – #{@division.max_age}"

      %p
        %strong Weight Range:
        = "#{@division.min_weight} – #{@division.max_weight} kg"

      %p
        %strong Belt:
        = @division.belt

      %p
        %strong Sex:
        = @division.sex
        
      %p
        %strong Cost (€):
        = @division.cost

      .mt-3.d-flex.gap-2.flex-wrap
        - if current_user.team? || current_user.admin?
          = link_to "Register Athletes", new_event_division_registration_path(@event, @division), class: "btn btn-success"
          
        - if current_user.admin?
          // = link_to "Generate Bracket", generate_bracket_event_division_path(@division.event, @division), class: "btn text-white", style: "background-color: #9d4edd;", data: { turbo_method: :post, turbo_confirm: "Are you sure you want to generate the bracket?" }
          = link_to "Generate Bracket", generate_bracket_event_division_path(@division.event, @division), class: "btn text-white", style: "background-color: #9d4edd;", data: { turbo_method: :post }
          
        = link_to "Edit Division", edit_event_division_path(@division.event, @division), class: "btn btn-primary"
        = link_to "Back to Event", @division.event, class: "btn btn-secondary"
        = link_to "Delete", event_division_path(@division.event, @division), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-danger"

  .mt-4
    %h3 Eligible Athletes
    %table.table.table-striped.table-bordered
      %thead
        %tr
          %th Name
          %th Birthdate
          %th Weight (kg)
          %th Belt
          %th Sex
          %th Team
          %th Registered
      %tbody
        - @eligible_athletes.each do |athlete|
          %tr
            %td= athlete.fullname
            %td= athlete.birthdate
            %td= athlete.weight
            %td= athlete.belt
            %td= athlete.sex
            %td= athlete.team.name
            %td.text-center
              - if @division.athletes.include?(athlete)
                %i.fa.fa-solid.fa-check-to-slot.text-success.fa-lg
              - else
                %i.fa.fa-solid.fa-square-xmark.text-danger.fa-lg

  - if @bouts_by_round.present?
    .mt-5
      .d-flex.justify-content-between.align-items-center.mb-4
        %h3.mb-0 Tournament Bracket
        - if current_user.admin?
          %small.text-muted
            %i.fa.fa-hand-pointer
            Drag and drop athletes to reorder
  
      - total_rounds = @bouts_by_round.keys.max
      - tournament_started = @division.bouts.where.not(winner_id: nil).exists?
  
      .bracket-container{ data: { controller: "drag" } }
        - @bouts_by_round.each do |round, bouts|
          .round-column{ data: { round: round } }
            %h5.mb-3.text-center
              - if round == 1
                Round 1
              - elsif round == total_rounds
                Champion
              - elsif round == total_rounds - 1
                Final
              - elsif round == total_rounds - 2
                Semi-Finals
              - else
                Round #{round}
            
            - bouts.each do |bout|
              .match-box{ id: "bout-#{bout.id}", data: { bout_id: bout.id } }
                - if round == total_rounds
                  -# Champion round - single slot (winner format)
                  .slot.athlete-slot.slot-a.champion-slot{ 
                    data: { 
                      drag_target: "slot", 
                      athlete_id: bout.athlete_a_id
                    }, 
                    draggable: "false"
                  }
                    - if bout.athlete_a
                      .athlete-name.fw-bold= bout.athlete_a.fullname
                      %small.team-name.text-muted= bout.athlete_a.team.name
                      .winner-badge.mt-2.text-center
                        %span.badge.text-dark{ style: "background-color: #ffd700;" }
                          %i.fa.fa-crown.me-1
                          CHAMPION
                    - else
                      .text-muted.fst-italic TBD
                - else
                  -# Regular bout
                  .slot.athlete-slot.slot-a{ 
                    data: { 
                      drag_target: "slot", 
                      athlete_id: bout.athlete_a_id,
                      action: "click->drag#selectWinner"
                    }, 
                    draggable: (current_user.admin? && !tournament_started) ? "true" : "false",
                    class: bout.winner_id == bout.athlete_a_id ? "winner-slot" : ""
                  }
                    - if bout.athlete_a
                      .athlete-name.fw-bold= bout.athlete_a.fullname
                      %small.team-name.text-muted= bout.athlete_a.team.name
                    - else
                      .text-muted.fst-italic TBD
                  
                  .vs-divider.text-center.my-2
                    %small.text-muted.fw-bold vs
                  
                  .slot.athlete-slot.slot-b{ 
                    data: { 
                      drag_target: "slot", 
                      athlete_id: bout.athlete_b_id,
                      action: "click->drag#selectWinner"
                    }, 
                    draggable: (current_user.admin? && !tournament_started) ? "true" : "false",
                    class: bout.winner_id == bout.athlete_b_id ? "winner-slot" : ""
                  }
                    - if bout.athlete_b
                      .athlete-name.fw-bold= bout.athlete_b.fullname
                      %small.team-name.text-muted= bout.athlete_b.team.name
                    - else
                      .text-muted.fst-italic TBD
                  
                  - if bout.winner
                    .winner-badge.mt-2.text-center
                      %span.badge.bg-success
                        %i.fa.fa-trophy.me-1
                        Winner: #{bout.winner.fullname}
                  - elsif bout.athlete_a && bout.athlete_b
                    .pending-badge.mt-2.text-center
                      %span.badge.bg-secondary
                        %i.fa.fa-clock.me-1
                        Click athlete to set winner
                      
  - else
    .mt-5
      .alert.alert-info.d-flex.align-items-center
        %i.fa.fa-info-circle.fa-2x.me-3
        .flex-grow-1
          %h5.alert-heading No Bracket Generated Yet
          %p.mb-0 Click the "Generate Bracket" button above to create the tournament bracket for this division.