.container.mt-4
  .card.shadow
    .card-header
      %h2.mb-0= "#{@division.event.name} #{@division.name}"

    .card-body
      %p
        %strong Event:
        = link_to @division.event.name, @division.event

      %p
        %strong Age Range:
        = "#{@division.min_age} â€“ #{@division.max_age}"

      %p
        %strong Weight Range:
        = "#{@division.min_weight} â€“ #{@division.max_weight} kg"

      %p
        %strong Belt:
        = @division.belt

      %p
        %strong Sex:
        = @division.sex
        
      %p
        %strong Cost (â‚¬):
        = @division.cost

      .mt-3.d-flex.gap-2.flex-wrap
        - if current_user.team? || current_user.admin?
          = link_to "Register Athletes", new_event_division_registration_path(@event, @division), class: "btn btn-success"
          
        - if current_user.admin?
          // = link_to "Generate Bracket", generate_bracket_event_division_path(@division.event, @division), class: "btn text-white", style: "background-color: #9d4edd;", data: { turbo_method: :post, turbo_confirm: "Are you sure you want to generate the bracket?" }
          = link_to "Generate Bracket", generate_bracket_event_division_path(@division.event, @division), class: "btn text-white", style: "background-color: #9d4edd;", data: { turbo_method: :post }
          
        = link_to "Edit Division", edit_event_division_path(@division.event, @division), class: "btn btn-primary"
        = link_to "Back to Event", @division.event, class: "btn btn-secondary"
        = link_to "Delete", event_division_path(@division.event, @division), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-danger"

  .mt-4
    %h3 Eligible Athletes
    %table.table.table-striped.table-bordered
      %thead
        %tr
          %th Name
          %th Birthdate
          %th Weight (kg)
          %th Belt
          %th Sex
          %th Team
          %th Registered
      %tbody
        - @eligible_athletes.each do |athlete|
          %tr
            %td= athlete.fullname
            %td= athlete.birthdate
            %td= athlete.weight
            %td= athlete.belt
            %td= athlete.sex
            %td= athlete.team.name
            %td.text-center
              - if @division.athletes.include?(athlete)
                %i.fa.fa-solid.fa-check-to-slot.text-success.fa-lg
              - else
                %i.fa.fa-solid.fa-square-xmark.text-danger.fa-lg

  - if @bouts_by_round.present?
    .mt-5
      .d-flex.justify-content-between.align-items-center.mb-4
        %h3.mb-0 Tournament Bracket
        - if current_user.admin?
          %small.text-muted
            %i.fa.fa-hand-pointer
            Drag and drop athletes to reorder
  
      - tournament_started = @division.bouts.where.not(winner_id: nil).exists?
      - normal_bouts = @bouts_by_round.reject { |round, bouts| bouts.any? { |b| ["final", "consolation", "champion"].include?(b.bout_type) } }
      - final_bout = @division.bouts.find_by(bout_type: "final")
      - consolation_bout = @division.bouts.find_by(bout_type: "consolation")
      - champion_bout = @division.bouts.find_by(bout_type: "champion")
  
      .bracket-container{ data: { controller: "drag" } }
        - normal_bouts.each do |round, bouts|
          .round-column{ data: { round: round } }
            %h5.mb-3.text-center
              - total_normal_rounds = normal_bouts.keys.max
              - rounds_before_final = total_normal_rounds - round
              
              - if rounds_before_final == 0
                Semi-Finals
              - elsif rounds_before_final == 1
                Quarter-Finals
              - elsif round == 1
                Round 1
              - else
                Round #{round}
            
            - bouts.each do |bout|
              .match-box{ id: "bout-#{bout.id}", data: { bout_id: bout.id } }
                .slot.athlete-slot.slot-a{ 
                  data: { 
                    drag_target: "slot", 
                    athlete_id: bout.athlete_a_id,
                    action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                  }, 
                  draggable: (current_user.can_manage_event?(@event) && !tournament_started) ? "true" : "false",
                  class: (bout.winner_id == bout.athlete_a_id && bout.winner_id.present? && bout.athlete_a_id.present?) ? "winner-slot" : ""
                }
                  - if bout.athlete_a
                    .athlete-name.fw-bold= bout.athlete_a.fullname
                    %small.team-name.text-muted= bout.athlete_a.team.name
                  - else
                    .text-muted.fst-italic TBD
                
                .vs-divider.text-center.my-2
                  %small.text-muted.fw-bold vs
                .slot.athlete-slot.slot-b{ 
                  data: { 
                    drag_target: "slot", 
                    athlete_id: bout.athlete_b_id,
                    action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                  }, 
                  draggable: (current_user.admin? && !tournament_started) ? "true" : "false",
                  class: (bout.winner_id == bout.athlete_b_id && bout.winner_id.present? && bout.athlete_b_id.present?) ? "winner-slot" : ""
                }
                  - if bout.athlete_b
                    .athlete-name.fw-bold= bout.athlete_b.fullname
                    %small.team-name.text-muted= bout.athlete_b.team.name
                  - else
                    .text-muted.fst-italic TBD
                
                - if bout.winner
                  .winner-badge.mt-2.text-center
                    %span.badge.bg-success
                      %i.fa.fa-trophy.me-1
                      Winner: #{bout.winner.fullname}
                - elsif bout.athlete_a && bout.athlete_b
                  .pending-badge.mt-2.text-center
                    %span.badge.bg-secondary
                      %i.fa.fa-clock.me-1
                      Click athlete to set winner
        
        - if final_bout && consolation_bout
          .round-column{ data: { round: final_bout.round } }
            %h5.mb-3.text-center Finals
            
            -# Final Bout
            .match-box.mb-4{ id: "bout-#{final_bout.id}", data: { bout_id: final_bout.id } }
              .text-center.mb-2
                %strong.text-primary Championship Final
              .slot.athlete-slot.slot-a{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: final_bout.athlete_a_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (final_bout.winner_id == final_bout.athlete_a_id && final_bout.winner_id.present? && final_bout.athlete_a_id.present?) ? "winner-slot" : ""
              }
                - if final_bout.athlete_a
                  .athlete-name.fw-bold= final_bout.athlete_a.fullname
                  %small.team-name.text-muted= final_bout.athlete_a.team.name
                - else
                  .text-muted.fst-italic TBD
              
              .vs-divider.text-center.my-2
                %small.text-muted.fw-bold vs
              
              .slot.athlete-slot.slot-b{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: final_bout.athlete_b_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (final_bout.winner_id == final_bout.athlete_b_id && final_bout.winner_id.present? && final_bout.athlete_b_id.present?) ? "winner-slot" : ""
              }
                - if final_bout.athlete_b
                  .athlete-name.fw-bold= final_bout.athlete_b.fullname
                  %small.team-name.text-muted= final_bout.athlete_b.team.name
                - else
                  .text-muted.fst-italic TBD
              
              - if final_bout.winner
                .winner-badge.mt-2.text-center
                  %span.badge.bg-success
                    %i.fa.fa-trophy.me-1
                    Winner: #{final_bout.winner.fullname}
              - elsif final_bout.athlete_a && final_bout.athlete_b
                .pending-badge.mt-2.text-center
                  %span.badge.bg-secondary
                    %i.fa.fa-clock.me-1
                    Click athlete to set winner
            
            -# Consolation Bout
            .match-box{ id: "bout-#{consolation_bout.id}", data: { bout_id: consolation_bout.id } }
              .text-center.mb-2
                %strong.text-warning Consolation Final
              .slot.athlete-slot.slot-a{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: consolation_bout.athlete_a_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (consolation_bout.winner_id == consolation_bout.athlete_a_id && consolation_bout.winner_id.present?) ? "winner-slot" : ""
              }
                - if consolation_bout.athlete_a
                  .athlete-name.fw-bold= consolation_bout.athlete_a.fullname
                  %small.team-name.text-muted= consolation_bout.athlete_a.team.name
                - else
                  .text-muted.fst-italic TBD
              
              .vs-divider.text-center.my-2
                %small.text-muted.fw-bold vs
              
              .slot.athlete-slot.slot-b{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: consolation_bout.athlete_b_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (consolation_bout.winner_id == consolation_bout.athlete_b_id && consolation_bout.winner_id.present?) ? "winner-slot" : ""
              }
                - if consolation_bout.athlete_b
                  .athlete-name.fw-bold= consolation_bout.athlete_b.fullname
                  %small.team-name.text-muted= consolation_bout.athlete_b.team.name
                - else
                  .text-muted.fst-italic TBD
              
              - if consolation_bout.winner
                .winner-badge.mt-2.text-center
                  %span.badge.bg-success
                    %i.fa.fa-trophy.me-1
                    Winner: #{consolation_bout.winner.fullname}
              - elsif consolation_bout.athlete_a && consolation_bout.athlete_b
                .pending-badge.mt-2.text-center
                  %span.badge.bg-secondary
                    %i.fa.fa-clock.me-1
                    Click athlete to set winner
        
        - if champion_bout
          .round-column{ data: { round: champion_bout.round } }
            %h5.mb-3.text-center Champions
            
            .match-box.champion-display{ id: "bout-#{champion_bout.id}", data: { bout_id: champion_bout.id } }
              -# 1st Place - Gold
              .slot.athlete-slot.champion-slot-gold{ data: { athlete_id: champion_bout.athlete_a_id } }
                - if champion_bout.athlete_a
                  .text-center
                    %i.fa.fa-trophy.fa-2x.mb-2{ style: "color: #ffd700;" }
                  .athlete-name.fw-bold= champion_bout.athlete_a.fullname
                  %small.team-name.text-muted= champion_bout.athlete_a.team.name
                  .winner-badge.mt-2.text-center
                    %span.badge.text-dark{ style: "background-color: #ffd700;" }
                      ðŸ¥‡ 1st Place
                - else
                  .text-muted.fst-italic TBD
              
              -# 2nd Place - Silver
              .slot.athlete-slot.champion-slot-silver.mt-3{ data: { athlete_id: champion_bout.loser_id } }
                - if champion_bout.loser
                  .text-center
                    %i.fa.fa-medal.fa-2x.mb-2{ style: "color: #c0c0c0;" }
                  .athlete-name.fw-bold= champion_bout.loser.fullname
                  %small.team-name.text-muted= champion_bout.loser.team.name
                  .winner-badge.mt-2.text-center
                    %span.badge.text-dark{ style: "background-color: #c0c0c0;" }
                      ðŸ¥ˆ 2nd Place
                - else
                  .text-muted.fst-italic TBD
              
              -# 3rd Place - Bronze
              .slot.athlete-slot.champion-slot-bronze.mt-3{ data: { athlete_id: champion_bout.athlete_b_id } }
                - if champion_bout.athlete_b
                  .text-center
                    %i.fa.fa-medal.fa-2x.mb-2{ style: "color: #cd7f32;" }
                  .athlete-name.fw-bold= champion_bout.athlete_b.fullname
                  %small.team-name.text-muted= champion_bout.athlete_b.team.name
                  .winner-badge.mt-2.text-center
                    %span.badge.text-white{ style: "background-color: #cd7f32;" }
                      ðŸ¥‰ 3rd Place
                - else
                  .text-muted.fst-italic TBD

  - else
    .mt-5
      .alert.alert-info.d-flex.align-items-center
        %i.fa.fa-info-circle.fa-2x.me-3
        .flex-grow-1
          %h5.alert-heading No Bracket Generated Yet
          - if current_user.can_manage_event?(@event)
            %p.mb-0 Click the "Generate Bracket" button above to create the tournament bracket for this division.
          - else
            %p.mb-0 The tournament bracket has not been created yet.