.card.shadow
  .card-header
    %h2.mb-0= "#{@division.event.name} #{@division.name}"

  .card-body
    %p
      %strong Event:
      = link_to @division.event.name, @division.event
      
    %p
      %strong Sex:
      = @division.sex

    %p
      %strong Age Range:
      = "#{@division.min_age} - #{@division.max_age}"
      
    %p
      %strong Weight Range:
      = "#{@division.min_weight} - #{@division.max_weight} kg"

    %p
      %strong Rank:
      = "#{@division.min_rank} - #{@division.max_rank}"

    %p
      %strong #{@division.event.competition_area_name}:
      = @division.court
      
    %p
      %strong Cost (â‚¬):
      = @division.cost
      
    %p
      %strong Rules:
      = @division.description

    .mt-3.d-flex.gap-2.flex-wrap
      = link_to "Register Athletes", new_event_division_registration_path(@event, @division), class: "btn btn-success"
        
      - if current_user.can_manage_event?(@division.event) && @division.registrations.any?
        = link_to "Generate Bracket", generate_bracket_event_division_path(@division.event, @division), class: "btn text-white", style: "background-color: #9d4edd;", data: { turbo_method: :post }
        
      = link_to "Edit Division", edit_event_division_path(@division.event, @division), class: "btn btn-primary"
      = link_to "Back to Event", @division.event, class: "btn btn-secondary"
      = link_to "Delete", event_division_path(@division.event, @division), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-danger"
      
-# Registered Teams Section
.mt-4
  .card
    .card-header
      %h4.mb-0
        %i.fa.fa-users.me-2
        Registered Teams
        %span.badge.bg-primary.ms-2= @teams_with_registrations.count
    .card-body
      - if @teams_with_registrations.any?
        .table-responsive
          %table.table.table-hover.table-striped
            %thead
              %tr
                %th Team Name
                %th Coach
                %th Registered Athletes
            %tbody
              - @teams_with_registrations.each do |team|
                - coach = team.team_admin_role&.user
                - registered_count = @division.registrations.joins(:athlete).where(athletes: { team_id: team.id }).count
                %tr
                  %td
                    %strong= team.name
                  %td
                    - if coach
                      = coach.fullname
                      %br
                      %small.text-muted= team.organization
                    - else
                      %span.text-muted No coach assigned
                  %td
                    %span.badge.bg-primary= registered_count
      - else
        .alert.alert-info.mb-0
          %i.fa.fa-info-circle.me-2
          No teams have registered athletes in this division yet.

-# Eligible Athletes Section
.mt-4
  .card
    .card-header
      %h4.mb-0
        %i.fa.fa-user-friends.me-2
        Eligible Athletes
        %span.badge.bg-primary.ms-2= @eligible_athletes.count
    .card-body
      - if @eligible_athletes.any?
        .table-responsive
          %table.table.table-hover.table-striped
            %thead
              %tr
                %th Name
                %th Birthdate
                %th Weight (kg)
                %th Rank
                %th Sex
                %th Team
                %th Registered
                %th Actions
            %tbody
              - @eligible_athletes.each do |athlete|
                - registration = @division.registrations.find_by(athlete_id: athlete.id)
                - is_registered = @division.athletes.include?(athlete)
                - is_own_team = current_user.administered_team.present? && athlete.team_id == current_user.administered_team.id
                - can_register = current_user.superadmin? || is_own_team
                - can_unregister = current_user.superadmin? || current_user.can_manage_event?(@event) || is_own_team
                %tr
                  %td
                    - if is_own_team
                      %i.fa.fa-star.text-success.me-2
                    = athlete.fullname
                  %td= athlete.birthdate.strftime("%d.%m.%Y")
                  %td= athlete.weight
                  %td
                    %span.badge.bg-secondary= athlete.rank
                  %td= athlete.sex
                  %td= athlete.team.name
                  %td.text-center
                    - if is_registered
                      %i.fa.fa-solid.fa-check-to-slot.text-success.fa-lg
                    - else
                      %i.fa.fa-solid.fa-square-xmark.text-danger.fa-lg
                  %td.text-center
                    - if is_registered && registration
                      - if can_unregister
                        = button_to event_division_registration_path(@event, @division, registration), 
                          method: :delete, 
                          data: { turbo_confirm: "Unregister #{athlete.fullname}?" }, 
                          class: "btn btn-sm btn-link p-0", 
                          title: "Unregister" do
                          %i.fa.fa-trash.text-danger.fa-lg
                      - else
                        %span.text-muted â€”
                    - elsif can_register
                      = button_to toggle_event_division_registrations_path(@event, @division, athlete_ids: [athlete.id]), 
                        method: :post, 
                        class: "btn btn-sm btn-link p-0", 
                        title: "Register" do
                        %i.fa.fa-plus-circle.text-success.fa-lg
                    - else
                      %span.text-muted â€”
      - else
        .alert.alert-info.mb-0
          %i.fa.fa-info-circle.me-2
          No eligible athletes for this division.

- if @bouts_by_round.present?
  .mt-5
    .d-flex.justify-content-between.align-items-center.mb-4
      %h3.mb-0 Tournament Bracket
      - if current_user.admin?
        %small.text-muted
          %i.fa.fa-hand-pointer
          Drag and drop athletes to reorder

    - tournament_started = @division.bouts.where.not(winner_id: nil).exists?
    - normal_bouts = @bouts_by_round.reject { |round, bouts| bouts.any? { |b| ["final", "consolation", "champion"].include?(b.bout_type) } }
    - final_bout = @division.bouts.find_by(bout_type: "final")
    - consolation_bout = @division.bouts.find_by(bout_type: "consolation")
    - champion_bout = @division.bouts.find_by(bout_type: "champion")
    - has_normal_rounds = normal_bouts.any?

    .bracket-container{ data: { controller: "drag" } }
      - if has_normal_rounds
        - normal_bouts.each do |round, bouts|
          .round-column{ data: { round: round } }
            %h5.mb-3.text-center
              - total_normal_rounds = normal_bouts.keys.max
              - rounds_before_final = total_normal_rounds - round
              
              - if rounds_before_final == 0
                Semi-Finals
              - elsif rounds_before_final == 1
                Quarter-Finals
              - elsif round == 1
                Round 1
              - else
                Round #{round}
            
            - bouts.each do |bout|
              .match-box{ id: "bout-#{bout.id}", data: { bout_id: bout.id } }
                .slot.athlete-slot.slot-a{ 
                  data: { 
                    drag_target: "slot", 
                    athlete_id: bout.athlete_a_id,
                    action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                  }, 
                  draggable: (current_user.can_manage_event?(@event) && !tournament_started) ? "true" : "false",
                  class: (bout.winner_id == bout.athlete_a_id && bout.winner_id.present? && bout.athlete_a_id.present?) ? "winner-slot" : ""
                }
                  = render 'athlete_slot_content', athlete: bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
                
                .vs-divider.text-center.my-2
                  %small.text-muted.fw-bold vs
                
                .slot.athlete-slot.slot-b{ 
                  data: { 
                    drag_target: "slot", 
                    athlete_id: bout.athlete_b_id,
                    action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                  }, 
                  draggable: (current_user.can_manage_event?(@event) && !tournament_started) ? "true" : "false",
                  class: (bout.winner_id == bout.athlete_b_id && bout.winner_id.present? && bout.athlete_b_id.present?) ? "winner-slot" : ""
                }
                  = render 'athlete_slot_content', athlete: bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
                
                - if bout.winner
                  .winner-badge.mt-2.text-center
                    %span.badge.bg-success
                      %i.fa.fa-trophy.me-1
                      Winner: #{bout.winner.fullname}
                - elsif bout.athlete_a && bout.athlete_b
                  .pending-badge.mt-2.text-center
                    %span.badge.bg-secondary
                      %i.fa.fa-clock.me-1
                      Click athlete to set winner
      
      - if final_bout
        .round-column{ data: { round: final_bout.round } }
          %h5.mb-3.text-center
            = consolation_bout ? "Finals" : "Final"
          
          -# Final Bout
          .match-box{ class: consolation_bout ? "mb-4" : "", id: "bout-#{final_bout.id}", data: { bout_id: final_bout.id } }
            .text-center.mb-2
              %strong.text-primary Championship Final
            .slot.athlete-slot.slot-a{ 
              data: { 
                drag_target: "slot", 
                athlete_id: final_bout.athlete_a_id,
                action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
              }, 
              draggable: "false",
              class: (final_bout.winner_id == final_bout.athlete_a_id && final_bout.winner_id.present? && final_bout.athlete_a_id.present?) ? "winner-slot" : ""
            }
              = render 'athlete_slot_content', athlete: final_bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
            
            .vs-divider.text-center.my-2
              %small.text-muted.fw-bold vs
            
            .slot.athlete-slot.slot-b{ 
              data: { 
                drag_target: "slot", 
                athlete_id: final_bout.athlete_b_id,
                action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
              }, 
              draggable: "false",
              class: (final_bout.winner_id == final_bout.athlete_b_id && final_bout.winner_id.present? && final_bout.athlete_b_id.present?) ? "winner-slot" : ""
            }
              = render 'athlete_slot_content', athlete: final_bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
            
            - if final_bout.winner
              .winner-badge.mt-2.text-center
                %span.badge.bg-success
                  %i.fa.fa-trophy.me-1
                  Winner: #{final_bout.winner.fullname}
            - elsif final_bout.athlete_a && final_bout.athlete_b
              .pending-badge.mt-2.text-center
                %span.badge.bg-secondary
                  %i.fa.fa-clock.me-1
                  Click athlete to set winner
            - elsif final_bout.athlete_a && !final_bout.athlete_b
              .pending-badge.mt-2.text-center
                %span.badge.bg-warning
                  %i.fa.fa-user-check.me-1
                  Click to award walkover victory
          
          -# Consolation Bout (only if it exists)
          - if consolation_bout
            .match-box{ id: "bout-#{consolation_bout.id}", data: { bout_id: consolation_bout.id } }
              .text-center.mb-2
                %strong.text-warning Consolation Final
              .slot.athlete-slot.slot-a{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: consolation_bout.athlete_a_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (consolation_bout.winner_id == consolation_bout.athlete_a_id && consolation_bout.winner_id.present? && consolation_bout.athlete_a_id.present?) ? "winner-slot" : ""
              }
                = render 'athlete_slot_content', athlete: consolation_bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
              
              .vs-divider.text-center.my-2
                %small.text-muted.fw-bold vs
              
              .slot.athlete-slot.slot-b{ 
                data: { 
                  drag_target: "slot", 
                  athlete_id: consolation_bout.athlete_b_id,
                  action: current_user.can_manage_event?(@event) ? "click->drag#selectWinner" : ""
                }, 
                draggable: "false",
                class: (consolation_bout.winner_id == consolation_bout.athlete_b_id && consolation_bout.winner_id.present? && consolation_bout.athlete_b_id.present?) ? "winner-slot" : ""
              }
                = render 'athlete_slot_content', athlete: consolation_bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
              
              - if consolation_bout.winner
                .winner-badge.mt-2.text-center
                  %span.badge.bg-success
                    %i.fa.fa-trophy.me-1
                    Winner: #{consolation_bout.winner.fullname}
              - elsif consolation_bout.athlete_a && consolation_bout.athlete_b
                .pending-badge.mt-2.text-center
                  %span.badge.bg-secondary
                    %i.fa.fa-clock.me-1
                    Click athlete to set winner
      
      - if champion_bout
        .round-column{ data: { round: champion_bout.round } }
          %h5.mb-3.text-center Champions
          
          .match-box.champion-display{ id: "bout-#{champion_bout.id}", data: { bout_id: champion_bout.id } }
            -# 1st Place - Gold
            .slot.athlete-slot.champion-slot-gold{ data: { athlete_id: champion_bout.athlete_a_id } }
              = render 'champion_slot_content', 
                       athlete: champion_bout.athlete_a, 
                       medal_color: '#ffd700',
                       medal_icon: 'trophy',
                       badge_class: 'text-dark',
                       badge_style: 'background-color: #ffd700;',
                       badge_text: 'ðŸ¥‡ 1st Place'
            
            -# 2nd Place - Silver (hide only if final was 1 athlete vs TBD)
            - total_athletes = @division.registrations.count
            - if total_athletes >= 2
              .slot.athlete-slot.champion-slot-silver.mt-3{ data: { athlete_id: champion_bout.loser_id } }
                = render 'champion_slot_content',
                         athlete: champion_bout.loser,
                         medal_color: '#c0c0c0',
                         medal_icon: 'medal',
                         badge_class: 'text-dark',
                         badge_style: 'background-color: #c0c0c0;',
                         badge_text: 'ðŸ¥ˆ 2nd Place'
            
            -# 3rd Place - Bronze (only show if consolation bout exists)
            - if consolation_bout
              .slot.athlete-slot.champion-slot-bronze.mt-3{ data: { athlete_id: champion_bout.athlete_b_id } }
                = render 'champion_slot_content',
                         athlete: champion_bout.athlete_b,
                         medal_color: '#cd7f32',
                         medal_icon: 'medal',
                         badge_class: 'text-white',
                         badge_style: 'background-color: #cd7f32;',
                         badge_text: 'ðŸ¥‰ 3rd Place'

- else
  .mt-5
    .alert.alert-info.d-flex.align-items-center
      %i.fa.fa-info-circle.fa-2x.me-3
      .flex-grow-1
        %h5.alert-heading No Bracket Generated Yet
        - if current_user.can_manage_event?(@event)
          %p.mb-0 Click the "Generate Bracket" button above to create the tournament bracket for this division.
        - else
          %p.mb-0 The tournament bracket has not been created yet.