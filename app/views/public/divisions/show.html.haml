.card.shadow
  .card-header.bg-primary.text-white
    %h2.mb-0= "#{@division.event.name} - #{@division.name}"

  .card-body
    .row
      .col-md-6
        %p
          %strong Event:
          = link_to @division.event.name, public_event_path(@division.event)

        %p
          %strong Age Range:
          = "#{@division.min_age} â€“ #{@division.max_age} years"

        %p
          %strong Weight Range:
          = "#{@division.min_weight} â€“ #{@division.max_weight} kg"

      .col-md-6
        %p
          %strong Belt:
          %span.badge.bg-secondary= @division.belt

        %p
          %strong Sex:
          %span.badge.bg-info= @division.sex

    .mt-3
      = link_to "â† Back to Event", public_event_path(@division.event), class: "btn btn-secondary"

-# Registered Athletes Section
.mt-4
  .card
    .card-header
      %h4.mb-0
        %i.fa.fa-users.me-2
        Registered Athletes
        %span.badge.bg-primary.ms-2= @registered_athletes.count
    .card-body
      - if @registered_athletes.any?
        .table-responsive
          %table.table.table-hover.table-striped
            %thead
              %tr
                %th Name
                %th Team
                %th Belt
                %th Weight
            %tbody
              - @registered_athletes.each do |athlete|
                %tr
                  %td
                    %strong= athlete.fullname
                  %td= athlete.team.name
                  %td
                    %span.badge.bg-secondary= athlete.belt
                  %td= "#{athlete.weight} kg"
      - else
        .alert.alert-info.mb-0
          %i.fa.fa-info-circle.me-2
          No athletes registered yet.

-# Tournament Bracket Section
- if @bouts_by_round.present?
  .mt-5
    .card
      .card-header.bg-success.text-white
        %h3.mb-0
          %i.fa.fa-trophy.me-2
          Tournament Bracket
  
      .card-body
        - normal_bouts = @bouts_by_round.reject { |round, bouts| bouts.any? { |b| ["final", "consolation", "champion"].include?(b.bout_type) } }
        - final_bout = @division.bouts.find_by(bout_type: "final")
        - consolation_bout = @division.bouts.find_by(bout_type: "consolation")
        - champion_bout = @division.bouts.find_by(bout_type: "champion")
        - has_normal_rounds = normal_bouts.any?
  
        .bracket-container
          - if has_normal_rounds
            - normal_bouts.each do |round, bouts|
              .round-column
                %h5.mb-3.text-center.text-primary
                  - total_normal_rounds = normal_bouts.keys.max
                  - rounds_before_final = total_normal_rounds - round
                  
                  - if rounds_before_final == 0
                    Semi-Finals
                  - elsif rounds_before_final == 1
                    Quarter-Finals
                  - elsif round == 1
                    Round 1
                  - else
                    Round #{round}
                
                - bouts.each do |bout|
                  .match-box.mb-3{ id: "bout-#{bout.id}", data: { bout_id: bout.id } }
                    .slot.athlete-slot.slot-a{ class: (bout.winner_id == bout.athlete_a_id && bout.winner_id.present? && bout.athlete_a_id.present?) ? "winner-slot" : "" }
                      = render 'divisions/athlete_slot_content', athlete: bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
                    
                    .vs-divider.text-center.my-2
                      %small.text-muted.fw-bold vs
                    
                    .slot.athlete-slot.slot-b{ class: (bout.winner_id == bout.athlete_b_id && bout.winner_id.present? && bout.athlete_b_id.present?) ? "winner-slot" : "" }
                      = render 'divisions/athlete_slot_content', athlete: bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
                    
                    - if bout.winner
                      .winner-badge.mt-2.text-center
                        %span.badge.bg-success
                          %i.fa.fa-trophy.me-1
                          Winner: #{bout.winner.fullname}
                    - elsif bout.athlete_a && bout.athlete_b
                      .pending-badge.mt-2.text-center
                        %span.badge.bg-warning.text-dark
                          %i.fa.fa-clock.me-1
                          Match Pending
          
          -# Finals Column
          - if final_bout
            .round-column
              %h5.mb-3.text-center.text-danger
                = consolation_bout ? "Finals" : "Final"
              
              -# Championship Final
              .match-box.mb-4.border-primary{ class: consolation_bout ? "" : "", style: "border: 3px solid #0d6efd;", id: "bout-#{final_bout.id}", data: { bout_id: final_bout.id } }
                .text-center.mb-2
                  %h6.text-primary
                    %i.fa.fa-trophy.me-1
                    Championship Final
                
                .slot.athlete-slot.slot-a{ class: (final_bout.winner_id == final_bout.athlete_a_id && final_bout.winner_id.present? && final_bout.athlete_a_id.present?) ? "winner-slot" : "" }
                  = render 'divisions/athlete_slot_content', athlete: final_bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
                
                .vs-divider.text-center.my-2
                  %small.text-muted.fw-bold vs
                
                .slot.athlete-slot.slot-b{ class: (final_bout.winner_id == final_bout.athlete_b_id && final_bout.winner_id.present? && final_bout.athlete_b_id.present?) ? "winner-slot" : "" }
                  = render 'divisions/athlete_slot_content', athlete: final_bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
                
                - if final_bout.winner
                  .winner-badge.mt-2.text-center
                    %span.badge.bg-success
                      %i.fa.fa-trophy.me-1
                      Winner: #{final_bout.winner.fullname}
                - elsif final_bout.athlete_a && final_bout.athlete_b
                  .pending-badge.mt-2.text-center
                    %span.badge.bg-warning.text-dark
                      %i.fa.fa-clock.me-1
                      Match Pending
              
              -# Consolation Final
              - if consolation_bout
                .match-box.border-warning{ style: "border: 2px solid #ffc107;", id: "bout-#{consolation_bout.id}", data: { bout_id: consolation_bout.id } }
                  .text-center.mb-2
                    %h6.text-warning
                      %i.fa.fa-medal.me-1
                      3rd Place Match
                  
                  .slot.athlete-slot.slot-a{ class: (consolation_bout.winner_id == consolation_bout.athlete_a_id && consolation_bout.winner_id.present?) ? "winner-slot" : "" }
                    = render 'divisions/athlete_slot_content', athlete: consolation_bout.athlete_a, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-danger text-white', style: '', text: 'AKA' }
                  
                  .vs-divider.text-center.my-2
                    %small.text-muted.fw-bold vs
                  
                  .slot.athlete-slot.slot-b{ class: (consolation_bout.winner_id == consolation_bout.athlete_b_id && consolation_bout.winner_id.present?) ? "winner-slot" : "" }
                    = render 'divisions/athlete_slot_content', athlete: consolation_bout.athlete_b, show_medal: false, medal_color: nil, show_trophy: false, place_badge: nil, corner_badge: { class: 'bg-primary text-white', style: '', text: 'SHIRO' }
                  
                  - if consolation_bout.winner
                    .winner-badge.mt-2.text-center
                      %span.badge.bg-success
                        %i.fa.fa-trophy.me-1
                        Winner: #{consolation_bout.winner.fullname}
                  - elsif consolation_bout.athlete_a && consolation_bout.athlete_b
                    .pending-badge.mt-2.text-center
                      %span.badge.bg-warning.text-dark
                        %i.fa.fa-clock.me-1
                        Match Pending
          
          -# Champions Podium
          - if champion_bout
            .round-column
              %h5.mb-3.text-center.text-success
                %i.fa.fa-trophy.me-2
                Final Results
              
              .match-box.champion-display{ id: "bout-#{champion_bout.id}", data: { bout_id: champion_bout.id } }
                -# 1st Place - Gold
                .slot.athlete-slot.champion-slot-gold{ data: { athlete_id: champion_bout.athlete_a_id } }
                  = render 'divisions/champion_slot_content', 
                           athlete: champion_bout.athlete_a, 
                           medal_color: '#ffd700',
                           medal_icon: 'medal',
                           badge_class: 'text-dark',
                           badge_style: 'background-color: #ffd700;',
                           badge_text: 'ðŸ¥‡ 1st Place'
                
                -# 2nd Place - Silver (hide only if final was 1 athlete vs TBD)
                - total_athletes = @division.registrations.count
                - if total_athletes >= 2
                  .slot.athlete-slot.champion-slot-silver.mt-3{ data: { athlete_id: champion_bout.loser_id } }
                    = render 'divisions/champion_slot_content',
                             athlete: champion_bout.loser,
                             medal_color: '#c0c0c0',
                             medal_icon: 'medal',
                             badge_class: 'text-dark',
                             badge_style: 'background-color: #c0c0c0;',
                             badge_text: 'ðŸ¥ˆ 2nd Place'
                
                -# 3rd Place - Bronze (only show if consolation bout exists)
                - if consolation_bout
                  .slot.athlete-slot.champion-slot-bronze.mt-3{ data: { athlete_id: champion_bout.athlete_b_id } }
                    = render 'divisions/champion_slot_content',
                             athlete: champion_bout.athlete_b,
                             medal_color: '#cd7f32',
                             medal_icon: 'medal',
                             badge_class: 'text-white',
                             badge_style: 'background-color: #cd7f32;',
                             badge_text: 'ðŸ¥‰ 3rd Place'

- else
  .mt-5
    .alert.alert-info.d-flex.align-items-center
      %i.fa.fa-info-circle.fa-2x.me-3
      .flex-grow-1
        %h5.alert-heading No Bracket Generated Yet
        %p.mb-0 The tournament bracket has not been created yet. Please check back later.